<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<title>Cashew Web Parser</title>
	 <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
    </style>
	<script src="jison.js"> </script>
  <script src="escodegen.browser.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script>

    (function () {
          var oldLog = console.log;
          console.log = function (message) {
              outputText.value += message + "\n";
              oldLog.apply(console, arguments);
          };
    })();

		function submitCode () {
      outputText.value = "";
			var code =document.getElementById('codeArea').value;
			 $.get("coco-java.jison",function(data){
      			 
              var Parser= require("jison").Parser;
      				grammar = data;
              var options = {'type' : 'slr'};
      				var parser = new Parser(grammar, options);
              var ast = {
                rootNode: {
                    type : "Program",
                    range: [],
                    body : []
                },
                currentNode: this.rootNode,
                createRoot: function(node, range) {
                 this.rootNode.range = range;
                 this.rootNode.body = this.rootNode.body.concat(node);
                 return this.rootNode;
                }

              };
              parser.yy.ast = ast;

              function node (type){
                this.type = type;

              }
              parser.yy.node = node; 

              function createLiteralNode(value, raw, range){
                var literalNode = new node("Literal");
                literalNode.range = range;
                literalNode.value = value;
                literalNode.raw = raw;
                return literalNode;
              }
              parser.yy.createLiteralNode = createLiteralNode;

              function createExpressionStatementNode(expression, range){
                var expressionStatementNode = new node("ExpressionStatement");
                expressionStatementNode.range = range
                expressionStatementNode.expression = expression;
                return expressionStatementNode;
              }
              parser.yy.createExpressionStatementNode = createExpressionStatementNode;


              parser.yy.JSON = JSON;

              function createConsoleLogExpression(arguments, range){
                var consoleLogNode = new node("CallExpression");
                consoleLogNode.range = range;
                consoleLogNode.arguments = [];
                consoleLogNode.arguments.push(arguments);
                var callee = new node("MemberExpression");
                callee.range = range;

                //TODO extract to a function
                var functions = new node("MemberExpression");
                functions.range = range;
                var runtime = new node("Identifier");
                runtime.range= range;
                runtime.name = "___JavaRuntime";

                var runtimeMethod = new node("Identifier");
                runtimeMethod.range= range;
                runtimeMethod.name = "functions";

                functions.object = runtime;
                functions.property = runtimeMethod;
                functions.computed = false;

                var printProperty = new node("Identifier");
                printProperty.range = range;
                printProperty.name = "print";

                callee.object = functions;
                callee.property = printProperty;
                callee.computed  = false;


                consoleLogNode.callee = callee;

                return consoleLogNode;
              }
              parser.yy.createConsoleLogExpression = createConsoleLogExpression;

              

      				var ast = parser.parse(code);
              astText.value = JSON.stringify(ast, null, 2);

              var js = escodegen.generate(ast);
              //This is just for testing really:
              js = "(function(___JavaRuntime){" + js + "})(___JavaRuntime);";


              

              
              jsText.value = js;
              eval(js);

  
			});
		}

    var ___JavaRuntime = { 
        functions : {
          print: function(str){
            console.log(str);
          }
        }


    }

	</script>

</head>
<body>
	<div><span>Cashew Web Parser </span><button onclick='submitCode()'>Parse it!</button>
    </div>
    <textarea id="codeArea" style="border: 1px solid black; width:49%; height:30%;">public class AddTwoNumbers
{
   /** main method */
   public static void main(String[] args)
   {
      System.out.println("Type your code here");
   }
}</textarea>
    <textarea id="jsText" style="border: 1px solid blue; width: 49%; height: 30%; " readonly="true"></textarea>
    <textarea id="astText" style="border: 1px solid purple; width: 49%; height: 69%; " readonly="true"></textarea>
    <textarea id="outputText" style="border: 1px solid green; width: 49%; height: 69%; " readonly="true"></textarea>
</body>
</html>